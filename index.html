<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>DreamsBox â€“ Ekspresikan Dirimu!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@700&display=swap" rel="stylesheet" />
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000;
        overflow: hidden;
        font-family: "Inter", sans-serif;
        touch-action: manipulation;
      }
      #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }
      #brand {
        position: fixed;
        top: 25px;
        left: 0;
        width: 100%;
        text-align: center;
        font: 900 7vw "Gaegu", cursive;
        color: #ff99cc;
        text-shadow: 3px 3px 15px #000;
        z-index: 10;
        pointer-events: none;
      }
      #countdown {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        font: 900 28vw "Gaegu";
        color: #ff99cc;
        text-shadow: 0 0 40px #000;
        z-index: 9;
        pointer-events: none;
        transition: transform 0.3s ease;
      }
      #countdown.show {
        transform: translate(-50%, -50%) scale(1);
      }
      #flash {
        position: fixed;
        inset: 0;
        background: #fff;
        opacity: 0;
        z-index: 8;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      #start {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        padding: 22px 90px;
        font: 900 28px "Gaegu";
        background: linear-gradient(45deg, #ff99cc, #ccffff);
        color: #fff;
        border: none;
        border-radius: 80px;
        box-shadow: 0 15px 40px rgba(255, 153, 204, 0.7);
        z-index: 10;
        cursor: pointer;
      }

      #selection {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 15;
        color: #fff;
      }
      #selection h3 {
        font: 900 36px "Gaegu";
        color: #ff99cc;
        margin-bottom: 50px;
        text-shadow: 0 0 10px #000;
      }
      .options {
        display: flex;
        gap: 25px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .opt-btn {
        width: 140px;
        height: 140px;
        background: #333;
        border: 4px solid #ff99cc;
        border-radius: 30px;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(255, 153, 204, 0.4);
        transition: all 0.3s;
        font: 900 48px "Gaegu";
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .opt-btn:hover {
        transform: scale(1.1);
        border-color: #fff;
      }

      #result {
        position: fixed;
        inset: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        background: #000;
        z-index: 20;
        padding: 4vh 0 120px;
        overflow-y: auto;
      }
      #result h2 {
        font: 900 36px "Gaegu";
        color: #ff99cc;
        margin: 0 0 30px 0;
        text-shadow: 0 0 10px #000;
      }
      #finalStrip {
        max-width: 92vw;
        border-radius: 30px;
        box-shadow: 0 15px 50px rgba(255, 153, 204, 0.6);
      }
      .btns {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 20px;
        background: #000000ee;
        display: flex;
        justify-content: center;
        gap: 15px;
        z-index: 25;
      }
      .btns button {
        padding: 16px 32px;
        font: 900 20px "Gaegu";
        border: none;
        border-radius: 50px;
        color: #fff;
        min-width: 130px;
        cursor: pointer;
      }
      #down {
        background: #ff99cc;
      }
      #wa {
        background: #25d366;
      }
      #again {
        background: #ccc;
      }

      @media (min-width: 600px) {
        #finalStrip {
          max-width: 420px;
        }
      }
    </style>
  </head>
  <body>
    <video id="video" autoplay playsinline muted></video>
    <div id="brand">DreamsBox</div>
    <div id="countdown"></div>
    <div id="flash"></div>
    <button id="start">MULAI DREAMSBOX</button>

    <div id="selection">
      <h3>Pilih Jumlah Foto</h3>
      <div class="options">
        <div class="opt-btn" data-num="3">3</div>
        <div class="opt-btn" data-num="4">4</div>
        <div class="opt-btn" data-num="5">5</div>
      </div>
    </div>

    <div id="result">
      <h2>Hasil DreamsBox</h2>
      <img id="finalStrip" alt="Photostrip" />
      <div class="btns">
        <button id="down">DOWNLOAD</button>
        <button id="wa">WHATSAPP</button>
        <button id="again">FOTO LAGI</button>
      </div>
    </div>

    <canvas id="canvas" style="display: none"></canvas>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const countEl = document.getElementById("countdown");
      const flashEl = document.getElementById("flash");
      const resultDiv = document.getElementById("result");
      const finalStrip = document.getElementById("finalStrip");
      const startBtn = document.getElementById("start");
      const selectionDiv = document.getElementById("selection");
      const downBtn = document.getElementById("down");
      const waBtn = document.getElementById("wa");
      const againBtn = document.getElementById("again");

      let shots = [];
      let NUM_SHOTS = 4;

      const filters = [
        "none",
        "contrast(110%) brightness(105%) saturate(120%)",
        "sepia(30%) contrast(110%)",
        "brightness(110%) contrast(115%)",
        "saturate(130%) hue-rotate(10deg)",
        "contrast(120%) brightness(108%)",
        "saturate(110%) brightness(105%)",
      ];

      function flashIt() {
        flashEl.style.opacity = 1;
        setTimeout(() => (flashEl.style.opacity = 0), 200);
      }
      function beep() {
        new Audio("https://assets.mixkit.co/sfx/preview/mixkit-camera-shutter-click-1133.mp3").play().catch(() => {});
      }

      async function countdown(n) {
        if (n === 0) {
          countEl.classList.remove("show");
          await new Promise((r) => setTimeout(r, 300));
          return;
        }
        countEl.textContent = n;
        countEl.classList.add("show");
        await new Promise((r) => setTimeout(r, 1000));
        return countdown(n - 1);
      }

      function snap() {
        const vW = video.videoWidth,
          vH = video.videoHeight;
        const size = Math.min(vW, vH);
        const sx = (vW - size) / 2,
          sy = (vH - size) / 2;
        canvas.width = canvas.height = size;
        ctx.filter = filters[Math.floor(Math.random() * filters.length)];
        ctx.drawImage(video, sx, sy, size, size, 0, 0, size, size);
        shots.push(canvas.toDataURL("image/jpeg", 0.95));
      }

      async function buildStrip() {
        const photoSize = canvas.width * 0.9;
        const gap = Math.round(photoSize * 0.15);
        const paddingY = Math.round(photoSize * 0.3);
        const footerH = Math.round(photoSize * 1.0);

        const stripW = canvas.width * 1.1;
        const stripH = paddingY * 2 + photoSize * NUM_SHOTS + gap * (NUM_SHOTS - 1) + footerH;

        const strip = document.createElement("canvas");
        strip.width = stripW;
        strip.height = stripH;
        const c = strip.getContext("2d");

        // Background pastel mint green soft
        c.fillStyle = "#e0fff5";
        c.fillRect(0, 0, stripW, stripH);

        // Rounded corner cute
        c.save();
        c.beginPath();
        c.roundRect(0, 0, stripW, stripH, 50);
        c.clip();

        // Tambah banyak emot-emot lucu di pinggir (nggak dikit lagi!)
        c.fillStyle = "#ff99cc";
        c.font = "45px Gaegu";
        const emots = ["ðŸ‘¾", "ðŸŽ®ðŸ•¹ï¸ðŸ‘¾", "ðŸ§¸à¾€à½²", "ð’…’ð’ˆ”ð’…’ð’‡«ð’„†", "Ëš.ðŸŽ€à¼˜â‹†", "â–¶â€¢ Ä±lÄ±Ä±lÄ±Ä±lÄ±lÄ±lÄ±Ä±lÄ±Ä±lÄ±. 0", "ðŸª¼â‹†ï½¡ð–¦¹Â°ðŸ«§â‹†.à³ƒà¿”*:ï½¥", "ðŸŽ¨", "ðŸŽ¸â‹†â­’Ëšï½¡â‹†", "ðŸ›¸", "ðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•", "â™«â‹†ï½¡â™ª â‚ŠËšâ™¬ ï¾Ÿ."];
        const positions = [
          { x: 0.05, y: 0.05 },
          { x: 0.95, y: 0.05 },
          { x: 0.05, y: 0.95 },
          { x: 0.95, y: 0.95 },
          { x: 0.5, y: 0.05 },
          { x: 0.5, y: 0.95 },
          { x: 0.1, y: 0.2 },
          { x: 0.9, y: 0.2 },
          { x: 0.1, y: 0.8 },
          { x: 0.9, y: 0.8 },
          { x: 0.2, y: 0.1 },
          { x: 0.8, y: 0.1 },
          { x: 0.2, y: 0.9 },
          { x: 0.8, y: 0.9 },
          { x: 0.3, y: 0.3 },
          { x: 0.7, y: 0.3 },
          { x: 0.3, y: 0.7 },
          { x: 0.7, y: 0.7 },
        ];
        positions.forEach((pos) => {
          const emot = emots[Math.floor(Math.random() * emots.length)];
          c.fillText(emot, stripW * pos.x, stripH * pos.y);
        });

        // Gambar foto dengan shadow pink halus
        let y = paddingY;
        const imgs = await Promise.all(
          shots.map(
            (src) =>
              new Promise((res) => {
                const i = new Image();
                i.crossOrigin = "anonymous";
                i.onload = () => res(i);
                i.src = src;
              })
          )
        );
        imgs.forEach((img) => {
          const x = (stripW - photoSize) / 2;
          c.shadowColor = "#ff99cc";
          c.shadowBlur = 20;
          c.drawImage(img, x, y, photoSize, photoSize);
          c.shadowBlur = 0;
          y += photoSize + gap;
        });

        c.restore();

        // Teks DreamsBox pink kawaii
        const today = new Date().toLocaleDateString("id-ID", { day: "numeric", month: "long", year: "numeric" });
        c.fillStyle = "#ff66aa";
        c.font = `bold ${Math.round(photoSize * 0.22)}px 'Gaegu',cursive`;
        c.textAlign = "center";
        c.textBaseline = "middle";
        c.fillText("DreamsBox", stripW / 2, stripH - footerH / 2 - 30);
        c.font = `bold ${Math.round(photoSize * 0.1)}px 'Gaegu',cursive`;
        c.fillText(today, stripW / 2, stripH - footerH / 2 + 50);

        const dataUrl = strip.toDataURL("image/jpeg", 0.96);
        finalStrip.src = dataUrl;

        downBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = `dreamsbox_${NUM_SHOTS}foto.jpg`;
          a.click();
        };
        waBtn.onclick = async () => {
          const blob = await (await fetch(dataUrl)).blob();
          const file = new File([blob], "dreamsbox.jpg", { type: "image/jpeg" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
              await navigator.share({ files: [file], title: "DreamsBox", text: `Hasil foto ${NUM_SHOTS} tanggal ${today} ðŸ’•` });
            } catch {
              fallbackWA();
            }
          } else fallbackWA();
        };
        function fallbackWA() {
          window.open(`https://wa.me/?text=Cek%20hasil%20DreamsBox%20aku%20${today}%20ðŸ’•`, "_blank");
        }

        resultDiv.style.display = "flex";
        startBtn.style.display = "none";
      }

      document.querySelectorAll(".opt-btn").forEach(
        (b) =>
          (b.onclick = () => {
            NUM_SHOTS = parseInt(b.dataset.num);
            selectionDiv.style.display = "none";
            startSession();
          })
      );

      async function startSession() {
        shots = [];
        for (let i = 0; i < NUM_SHOTS; i++) {
          await countdown(3);
          flashIt();
          beep();
          snap();
          await new Promise((r) => setTimeout(r, 800));
        }
        await buildStrip();
      }

      startBtn.onclick = () => {
        startBtn.style.display = "none";
        selectionDiv.style.display = "flex";
      };
      againBtn.onclick = () => {
        resultDiv.style.display = "none";
        startBtn.style.display = "block";
      };

      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "user" } })
        .then((s) => {
          video.srcObject = s;
          video.play();
        })
        .catch(() => alert("Izinkan akses kamera ya biar DreamsBox bisa jalan! ðŸ’•"));
    </script>
  </body>
</html>
